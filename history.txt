echo "generating ssh keys ..."
ssh-keygen -t rsa -b 4096 -C "for ansible" -N "" -f ~/.ssh/id_rsa
sleep 5

echo "password" > password.txt
echo "updating the system ..."
echo "password" | sudo -S apt update -y
echo "password" | sudo -S apt install sshpass -y
sleep 5

cat > script.sh << 'EOF'
#!/bin/bash

for user in ansible root
do
  for os in ubuntu centos
  do
    for instance in 1 2 3
    do
      echo "Copying SSH key to ${user}@${os}${instance}..."
      sshpass -f password.txt ssh-copy-id -o StrictHostKeyChecking=no ${user}@${os}${instance}
    done
  done
done
EOF

chmod +x script.sh 
./script.sh 

echo "modifying remote sudoers file.."

ssh root@centos1 "sed -i '/^# %wheel.*NOPASSWD: ALL/a ansible ALL=(ALL) NOPASSWD: ALL' /etc/sudoers"
ssh root@centos2 "sed -i '/^# %wheel.*NOPASSWD: ALL/a ansible ALL=(ALL) NOPASSWD: ALL' /etc/sudoers"
ssh root@centos3 "sed -i '/^# %wheel.*NOPASSWD: ALL/a ansible ALL=(ALL) NOPASSWD: ALL' /etc/sudoers"

ssh root@ubuntu1 'echo "ansible ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/ansible && chmod 0440 /etc/sudoers.d/ansible'
ssh root@ubuntu2 'echo "ansible ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/ansible && chmod 0440 /etc/sudoers.d/ansible'
ssh root@ubuntu3 'echo "ansible ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/ansible && chmod 0440 /etc/sudoers.d/ansible'

echo "pinging all available hosts..."
ansible all -i ubuntu1,ubuntu2,ubuntu3,centos1,centos2,centos3 -m ping

echo "modifying port on centos1"
ssh root@centos1 "/utils/update_sshd_ports.sh 2222"
